<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Optimizer</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      code.sourceCode > span { display: inline-block; line-height: 1.25; }
  code.sourceCode > span { color: inherit; text-decoration: inherit; }
  code.sourceCode > span:empty { height: 1.2em; }
  .sourceCode { overflow: visible; }
  code.sourceCode { white-space: pre; position: relative; }
  div.sourceCode { margin: 1em 0; }
  pre.sourceCode { margin: 0; }
  @media screen {
  div.sourceCode { overflow: auto; }
  }
  @media print {
  code.sourceCode { white-space: pre-wrap; }
  code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
  }
  pre.numberSource code
    { counter-reset: source-line 0; }
  pre.numberSource code > span
    { position: relative; left: -4em; counter-increment: source-line; }
  pre.numberSource code > span > a:first-child::before
    { content: counter(source-line);
      position: relative; left: -1em; text-align: right; vertical-align: baseline;
      border: none; display: inline-block;
      -webkit-touch-callout: none; -webkit-user-select: none;
      -khtml-user-select: none; -moz-user-select: none;
      -ms-user-select: none; user-select: none;
      padding: 0 4px; width: 4em;
      color: #aaaaaa;
    }
  pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
  div.sourceCode
    {   }
  @media screen {
  code.sourceCode > span > a:first-child::before { text-decoration: underline; }
  }
  code span.al { color: #ff0000; font-weight: bold; } /* Alert */
  code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
  code span.at { color: #7d9029; } /* Attribute */
  code span.bn { color: #40a070; } /* BaseN */
  code span.bu { } /* BuiltIn */
  code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
  code span.ch { color: #4070a0; } /* Char */
  code span.cn { color: #880000; } /* Constant */
  code span.co { color: #60a0b0; font-style: italic; } /* Comment */
  code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
  code span.do { color: #ba2121; font-style: italic; } /* Documentation */
  code span.dt { color: #902000; } /* DataType */
  code span.dv { color: #40a070; } /* DecVal */
  code span.er { color: #ff0000; font-weight: bold; } /* Error */
  code span.ex { } /* Extension */
  code span.fl { color: #40a070; } /* Float */
  code span.fu { color: #06287e; } /* Function */
  code span.im { } /* Import */
  code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  code span.kw { color: #007020; font-weight: bold; } /* Keyword */
  code span.op { color: #666666; } /* Operator */
  code span.ot { color: #007020; } /* Other */
  code span.pp { color: #bc7a00; } /* Preprocessor */
  code span.sc { color: #4070a0; } /* SpecialChar */
  code span.ss { color: #bb6688; } /* SpecialString */
  code span.st { color: #4070a0; } /* String */
  code span.va { color: #19177c; } /* Variable */
  code span.vs { color: #4070a0; } /* VerbatimString */
  code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Optimizer</h1>



<div id="intro" class="section level2">
<h2>Intro</h2>
<p>The <a href="https://github.com/fastai/fastai">fastai</a> library simplifies training fast and accurate neural nets using modern best practices. See the fastai website to get started. The library is based on research into deep learning best practices undertaken at <code>fast.ai</code>, and includes “out of the box” support for <code>vision</code>, <code>text</code>, <code>tabular</code>, and <code>collab</code> (collaborative filtering) models.</p>
<p>Interesting posts about NN from scratch using R:</p>
<ul>
<li><a href="https://rviews.rstudio.com/2020/07/20/shallow-neural-net-from-scratch-using-r-part-1/">Part 1</a></li>
<li><a href="https://rviews.rstudio.com/2020/07/24/building-a-neural-net-from-scratch-using-r-part-2/">Part 2</a></li>
</ul>
</div>
<div id="basic-steppers" class="section level2">
<h2>Basic steppers</h2>
<p>To be able to give examples of optimizer steps, we will need some steppers, like the following:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(magrittr)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(fastai)</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a>tst_param =<span class="st"> </span><span class="cf">function</span>(val, <span class="dt">grad =</span> <span class="ot">NULL</span>) {</span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="st">&quot;Create a tensor with `val` and a gradient of `grad` for testing&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>  res =<span class="st"> </span><span class="kw">tensor</span>(val) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">float</span>()</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(grad)) {</span>
<span id="cb1-9"><a href="#cb1-9"></a>    grad =<span class="st"> </span><span class="kw">tensor</span>(val <span class="op">/</span><span class="st"> </span><span class="dv">10</span>)</span>
<span id="cb1-10"><a href="#cb1-10"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-11"><a href="#cb1-11"></a>    grad =<span class="st"> </span><span class="kw">tensor</span>(grad)</span>
<span id="cb1-12"><a href="#cb1-12"></a>  }</span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a>  res<span class="op">$</span>grad =<span class="st"> </span>grad <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">float</span>()</span>
<span id="cb1-15"><a href="#cb1-15"></a>  res</span>
<span id="cb1-16"><a href="#cb1-16"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>p =<span class="st"> </span><span class="kw">tst_param</span>(<span class="fl">1.</span>, <span class="fl">0.1</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a>p</span></code></pre></div>
<pre><code>tensor(1.)</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">sgd_step</span>(p, <span class="fl">1.</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a>p</span></code></pre></div>
<pre><code>tensor(0.9000)</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>p<span class="op">$</span>grad</span></code></pre></div>
<pre><code>tensor(0.1000)</code></pre>
</div>
<div id="weight-decay" class="section level2">
<h2>Weight decay</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>p =<span class="st"> </span><span class="kw">tst_param</span>(<span class="fl">1.</span>, <span class="fl">0.1</span>)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">weight_decay</span>(p, <span class="fl">1.</span>, <span class="fl">0.1</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a>p</span></code></pre></div>
<pre><code>tensor(0.9000)</code></pre>
</div>
<div id="l2-regularization" class="section level2">
<h2>L2 regularization</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>p =<span class="st"> </span><span class="kw">tst_param</span>(<span class="fl">1.</span>, <span class="fl">0.1</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="kw">l2_reg</span>(p, <span class="fl">1.</span>, <span class="fl">0.1</span>)</span>
<span id="cb10-3"><a href="#cb10-3"></a>p<span class="op">$</span>grad</span></code></pre></div>
<pre><code>tensor(0.2000)</code></pre>
</div>
<div id="making-the-step" class="section level2">
<h2>Making the step</h2>
<p>This method will loop over all param groups, then all parameters for which <code>grad</code> is not <code>NULL</code> and call each function in <code>stepper</code>, passing it the parameter p with the hyper-parameters in the corresponding dict in <code>hypers</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>params =<span class="st"> </span><span class="kw">L</span>(<span class="kw">lapply</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x) <span class="kw">tst_param</span>(x)))</span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a>opt =<span class="st"> </span><span class="kw">Optimizer</span>(params, sgd_step, <span class="dt">lr=</span><span class="fl">0.1</span>)</span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb12-6"><a href="#cb12-6"></a></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="kw">str</span>(params<span class="op">$</span>items)</span></code></pre></div>
<pre><code>List of 4
 $ :tensor(0.)
 $ :tensor(0.9900)
 $ :tensor(1.9800)
 $ :tensor(2.9700)</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>params =<span class="st"> </span><span class="kw">L</span>(<span class="kw">lapply</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x) <span class="kw">tst_param</span>(x)))</span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a>opt =<span class="st"> </span><span class="kw">Optimizer</span>(params, <span class="kw">list</span>(weight_decay, sgd_step), <span class="dt">lr=</span><span class="fl">0.1</span>, <span class="dt">wd =</span> <span class="fl">0.1</span>)</span>
<span id="cb14-4"><a href="#cb14-4"></a></span>
<span id="cb14-5"><a href="#cb14-5"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb14-6"><a href="#cb14-6"></a></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="kw">str</span>(params<span class="op">$</span>items)</span></code></pre></div>
<pre><code>List of 4
 $ :tensor(0.)
 $ :tensor(0.9800)
 $ :tensor(1.9600)
 $ :tensor(2.9400)</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>params =<span class="st"> </span><span class="kw">L</span>(<span class="kw">lapply</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x) <span class="kw">tst_param</span>(x)))</span>
<span id="cb16-2"><a href="#cb16-2"></a></span>
<span id="cb16-3"><a href="#cb16-3"></a>opt =<span class="st"> </span><span class="kw">Optimizer</span>(params, sgd_step, <span class="dt">lr=</span><span class="fl">0.1</span>)</span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="kw">try</span>(params[<span class="dv">3</span>]<span class="op">$</span>grad &lt;-<span class="st"> </span><span class="ot">NULL</span>,</span>
<span id="cb16-6"><a href="#cb16-6"></a>    <span class="ot">TRUE</span>)</span>
<span id="cb16-7"><a href="#cb16-7"></a></span>
<span id="cb16-8"><a href="#cb16-8"></a>params[<span class="dv">3</span>]<span class="op">$</span>grad</span>
<span id="cb16-9"><a href="#cb16-9"></a></span>
<span id="cb16-10"><a href="#cb16-10"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb16-11"><a href="#cb16-11"></a></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="kw">str</span>(params<span class="op">$</span>items)</span></code></pre></div>
<pre><code>List of 4
 $ :tensor(0.)
 $ :tensor(0.9900)
 $ :tensor(1.9800)
 $ :tensor(3.)</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>params =<span class="st"> </span><span class="kw">L</span>(<span class="kw">lapply</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x) <span class="kw">tst_param</span>(x)))</span>
<span id="cb18-2"><a href="#cb18-2"></a></span>
<span id="cb18-3"><a href="#cb18-3"></a>opt =<span class="st"> </span><span class="kw">Optimizer</span>(<span class="kw">list</span>(params[<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>],params[<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>]), sgd_step, <span class="dt">lr=</span><span class="fl">0.1</span>)</span>
<span id="cb18-4"><a href="#cb18-4"></a></span>
<span id="cb18-5"><a href="#cb18-5"></a>opt<span class="op">$</span>hypers<span class="op">$</span>items[[<span class="dv">1</span>]][[<span class="dv">1</span>]] =<span class="st"> </span><span class="fl">0.01</span></span>
<span id="cb18-6"><a href="#cb18-6"></a></span>
<span id="cb18-7"><a href="#cb18-7"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb18-8"><a href="#cb18-8"></a></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="kw">str</span>(params<span class="op">$</span>items)</span></code></pre></div>
<pre><code>List of 4
 $ :tensor(0.)
 $ :tensor(0.9990)
 $ :tensor(1.9800)
 $ :tensor(2.9700)</code></pre>
</div>
<div id="zero-grad" class="section level2">
<h2>Zero grad</h2>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>params =<span class="st"> </span><span class="kw">L</span>(<span class="kw">lapply</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x) <span class="kw">tst_param</span>(x)))</span>
<span id="cb20-2"><a href="#cb20-2"></a></span>
<span id="cb20-3"><a href="#cb20-3"></a>opt =<span class="st"> </span><span class="kw">Optimizer</span>(params, <span class="kw">list</span>(weight_decay, sgd_step), <span class="dt">lr=</span><span class="fl">0.1</span>, <span class="dt">wd =</span> <span class="fl">0.1</span>)</span>
<span id="cb20-4"><a href="#cb20-4"></a></span>
<span id="cb20-5"><a href="#cb20-5"></a>opt<span class="op">$</span><span class="kw">zero_grad</span>()</span>
<span id="cb20-6"><a href="#cb20-6"></a></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="kw">str</span>(params<span class="op">$</span>items)</span></code></pre></div>
<pre><code>List of 4
 $ :tensor(0.)
 $ :tensor(1.)
 $ :tensor(2.)
 $ :tensor(3.)</code></pre>
</div>
<div id="average-grad" class="section level2">
<h2>Average grad</h2>
<p>Keeps track of the avg grads of <code>p</code> in <code>state</code> with <code>mom</code>.</p>
<p>`<code>dampening = FALSE</code> gives the classical formula for momentum in SGD:</p>
<ul>
<li>new_val = old_val * mom + grad</li>
</ul>
<p>whereas <code>dampening = TRUE</code> makes it an exponential moving average:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>p =<span class="st"> </span><span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>))</span>
<span id="cb22-2"><a href="#cb22-2"></a>state =<span class="st"> </span><span class="kw">average_grad</span>(p, <span class="dt">mom =</span> <span class="fl">0.9</span>, <span class="dt">dampening =</span> <span class="ot">FALSE</span>, <span class="dt">grad_avg =</span> <span class="ot">NULL</span>)</span>
<span id="cb22-3"><a href="#cb22-3"></a>p<span class="op">$</span>grad</span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="co"># tensor([4., 5., 6.])</span></span>
<span id="cb22-5"><a href="#cb22-5"></a></span>
<span id="cb22-6"><a href="#cb22-6"></a>state =<span class="st"> </span><span class="kw">average_grad</span>(p, <span class="dt">mom=</span><span class="fl">0.9</span>, <span class="dt">dampening =</span> <span class="ot">TRUE</span>)</span>
<span id="cb22-7"><a href="#cb22-7"></a>p<span class="op">$</span>grad<span class="op">*</span><span class="fl">0.1</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="co"># tensor([0.4000, 0.5000, 0.6000])</span></span>
<span id="cb22-9"><a href="#cb22-9"></a>p<span class="op">$</span>grad<span class="op">*</span>(<span class="fl">0.1</span><span class="op">*</span><span class="fl">0.9+0.1</span>)</span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="co"># tensor([0.7600, 0.9500, 1.1400])</span></span></code></pre></div>
</div>
<div id="average-sqr_grad" class="section level2">
<h2>Average sqr_grad</h2>
<p><code>dampening = FALSE</code> gives the classical formula for momentum in SGD:</p>
<ul>
<li>new_val = old_val * mom + grad**2</li>
</ul>
<p>whereas <code>dampening = TRUE</code> makes it an exponential moving average:</p>
<ul>
<li>new_val = old_val * mom + (grad ** 2) * (1-mom)</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>p =<span class="st"> </span><span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>))</span>
<span id="cb23-2"><a href="#cb23-2"></a>state =<span class="st"> </span><span class="kw">average_sqr_grad</span>(p, <span class="dt">sqr_mom =</span> <span class="fl">0.99</span>, <span class="dt">dampening =</span> <span class="ot">FALSE</span>)</span>
<span id="cb23-3"><a href="#cb23-3"></a></span>
<span id="cb23-4"><a href="#cb23-4"></a>p<span class="op">$</span>grad<span class="op">$</span><span class="kw">pow</span>(<span class="dv">2</span>)</span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="co"># tensor([16., 25., 36.])</span></span>
<span id="cb23-6"><a href="#cb23-6"></a></span>
<span id="cb23-7"><a href="#cb23-7"></a>p<span class="op">$</span>grad<span class="op">$</span><span class="kw">pow</span>(<span class="dv">2</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1.99</span></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="co"># tensor([31.8400, 49.7500, 71.6400])</span></span>
<span id="cb23-9"><a href="#cb23-9"></a> </span>
<span id="cb23-10"><a href="#cb23-10"></a>state =<span class="st"> </span><span class="kw">average_sqr_grad</span>(p, <span class="dt">sqr_mom =</span> <span class="fl">0.99</span>)</span>
<span id="cb23-11"><a href="#cb23-11"></a>p<span class="op">$</span>grad<span class="op">$</span><span class="kw">pow</span>(<span class="dv">2</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1e-2</span></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="co"># tensor([0.1600, 0.2500, 0.3600])</span></span>
<span id="cb23-13"><a href="#cb23-13"></a>state =<span class="st"> </span><span class="kw">average_sqr_grad</span>(p, <span class="dt">sqr_mom =</span> <span class="fl">0.99</span>)</span>
<span id="cb23-14"><a href="#cb23-14"></a></span>
<span id="cb23-15"><a href="#cb23-15"></a>p<span class="op">$</span>grad<span class="op">$</span><span class="kw">pow</span>(<span class="dv">2</span>)<span class="op">*</span>(<span class="fl">0.01</span><span class="op">*</span><span class="fl">0.99+0.01</span>)</span>
<span id="cb23-16"><a href="#cb23-16"></a><span class="co"># tensor([0.3184, 0.4975, 0.7164])</span></span>
<span id="cb23-17"><a href="#cb23-17"></a></span>
<span id="cb23-18"><a href="#cb23-18"></a>params =<span class="st"> </span><span class="kw">L</span>(<span class="kw">lapply</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x) <span class="kw">tst_param</span>(x)))</span>
<span id="cb23-19"><a href="#cb23-19"></a>opt =<span class="st"> </span><span class="kw">Optimizer</span>(params, sgd_step, <span class="dt">lr =</span> <span class="fl">0.1</span>)</span>
<span id="cb23-20"><a href="#cb23-20"></a>opt<span class="op">$</span><span class="kw">freeze_to</span>(1L)</span></code></pre></div>
</div>
<div id="sgd" class="section level2">
<h2>SGD</h2>
<p>A <code>Optimizer</code> for SGD with <code>lr</code> and <code>mom</code> and <code>params</code>.</p>
<p>Optional weight decay of <code>wd</code> is applied, as true weight decay (decay the weights directly) if <code>decouple_wd = TRUE</code> else as <code>L2</code> regularization (add the decay to the gradients).</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>params =<span class="st"> </span><span class="kw">L</span>(<span class="kw">lapply</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x) <span class="kw">tst_param</span>(x)))</span>
<span id="cb24-2"><a href="#cb24-2"></a>opt =<span class="st"> </span><span class="kw">SGD</span>(params, <span class="dt">lr =</span> <span class="fl">0.1</span>)</span>
<span id="cb24-3"><a href="#cb24-3"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="kw">str</span>(params<span class="op">$</span>items)</span></code></pre></div>
<pre><code>List of 4
 $ :tensor(0.)
 $ :tensor(0.9900)
 $ :tensor(1.9800)
 $ :tensor(2.9700)</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>params =<span class="st"> </span><span class="kw">L</span>(<span class="kw">lapply</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x) <span class="kw">tst_param</span>(x)))</span>
<span id="cb26-2"><a href="#cb26-2"></a>opt =<span class="st"> </span><span class="kw">SGD</span>(params, <span class="dt">lr =</span> <span class="fl">0.1</span>, <span class="dt">mom =</span> <span class="fl">0.9</span>)</span>
<span id="cb26-3"><a href="#cb26-3"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="kw">str</span>(params<span class="op">$</span>items)</span></code></pre></div>
<pre><code>List of 4
 $ :tensor(0.)
 $ :tensor(0.9900)
 $ :tensor(1.9800)
 $ :tensor(2.9700)</code></pre>
<p>Test weight decay, notice how we can see that <code>L2</code> regularization is different from weight decay even for simple SGD with momentum.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>params =<span class="st">  </span><span class="kw">L</span>(<span class="kw">lapply</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x) <span class="kw">tst_param</span>(x)))</span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="co">#Weight decay</span></span>
<span id="cb28-3"><a href="#cb28-3"></a>opt =<span class="st"> </span><span class="kw">SGD</span>(params, <span class="dt">lr=</span><span class="fl">0.1</span>, <span class="dt">mom=</span><span class="fl">0.9</span>, <span class="dt">wd=</span><span class="fl">0.1</span>)</span>
<span id="cb28-4"><a href="#cb28-4"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="kw">str</span>(params<span class="op">$</span>items)</span></code></pre></div>
<pre><code>List of 4
 $ :tensor(0.)
 $ :tensor(0.9800)
 $ :tensor(1.9600)
 $ :tensor(2.9400)</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>params =<span class="st">  </span><span class="kw">L</span>(<span class="kw">lapply</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x) <span class="kw">tst_param</span>(x)))</span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="co">#L2 reg</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>opt =<span class="st"> </span><span class="kw">SGD</span>(params, <span class="dt">lr=</span><span class="fl">0.1</span>, <span class="dt">mom=</span><span class="fl">0.9</span>, <span class="dt">wd=</span><span class="fl">0.1</span>, <span class="dt">decouple_wd=</span><span class="ot">FALSE</span>)</span>
<span id="cb30-4"><a href="#cb30-4"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="kw">str</span>(params<span class="op">$</span>items)</span></code></pre></div>
<pre><code>List of 4
 $ :tensor(0.)
 $ :tensor(0.9800)
 $ :tensor(1.9600)
 $ :tensor(2.9400)</code></pre>
</div>
<div id="rmsprop" class="section level2">
<h2>RMSProp</h2>
<p>A <code>Optimizer</code> for <code>RMSProp</code> with <code>lr</code>, <code>sqr_mom</code>, <code>mom</code> and <code>params</code>.</p>
<p><code>RMSProp</code> was introduced by Geoffrey Hinton in <a href="http://www.cs.toronto.edu/~tijmen/csc321/slides/lecture_slides_lec6.pdf">his course</a>. What is named <code>sqr_mom</code> here is the <code>alpha</code> in the course. Optional weight decay of <code>wd</code> is applied, as true weight decay (decay the weights directly) if <code>decouple_wd = TRUE</code> else as L2 regularization (add the decay to the gradients).</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>params =<span class="st"> </span><span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>))</span>
<span id="cb32-2"><a href="#cb32-2"></a>opt =<span class="st"> </span><span class="kw">RMSProp</span>(params, <span class="dt">lr=</span><span class="fl">0.1</span>)</span>
<span id="cb32-3"><a href="#cb32-3"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb32-4"><a href="#cb32-4"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb32-5"><a href="#cb32-5"></a>step =<span class="st"> </span>(<span class="op">-</span><span class="fl">0.1</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.1</span>) <span class="op">/</span><span class="st"> </span>(<span class="kw">sqrt</span>((<span class="fl">0.01</span><span class="op">*</span><span class="fl">0.99+0.01</span>) <span class="op">*</span><span class="st"> </span><span class="fl">0.1</span><span class="op">**</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="fl">1e-8</span>)</span>
<span id="cb32-6"><a href="#cb32-6"></a>params; <span class="kw">tensor</span>(<span class="kw">c</span>(step, <span class="dv">1</span><span class="op">+</span>step, <span class="dv">2</span><span class="op">+</span>step))</span></code></pre></div>
<pre><code>tensor([-0.7089,  0.2911,  1.2911])
tensor([-0.7089,  0.2911,  1.2911])</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>params =<span class="st"> </span><span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>))</span>
<span id="cb34-2"><a href="#cb34-2"></a>opt =<span class="st"> </span><span class="kw">RMSProp</span>(params, <span class="dt">lr=</span><span class="fl">0.1</span>, <span class="dt">mom=</span><span class="fl">0.9</span>)</span>
<span id="cb34-3"><a href="#cb34-3"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb34-4"><a href="#cb34-4"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb34-5"><a href="#cb34-5"></a>step =<span class="st"> </span>(<span class="op">-</span><span class="st"> </span><span class="fl">0.1</span> <span class="op">*</span><span class="st"> </span>(<span class="fl">0.1</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.9</span><span class="op">*</span><span class="fl">0.1</span>)) <span class="op">/</span><span class="st"> </span>(<span class="kw">sqrt</span>((<span class="fl">0.01</span><span class="op">*</span><span class="fl">0.99+0.01</span>) <span class="op">*</span><span class="st"> </span><span class="fl">0.1</span><span class="op">**</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="fl">1e-8</span>)</span>
<span id="cb34-6"><a href="#cb34-6"></a>params; <span class="kw">tensor</span>(<span class="kw">c</span>(step, <span class="dv">1</span><span class="op">+</span>step, <span class="dv">2</span><span class="op">+</span>step))</span></code></pre></div>
<pre><code>tensor([-1.3469, -0.3469,  0.6531])
tensor([-1.3469, -0.3469,  0.6531])</code></pre>
</div>
<div id="adam" class="section level2">
<h2>Adam</h2>
<p>A Optimizer for Adam with <code>lr</code>, <code>mom</code>, <code>sqr_mom</code>, <code>eps</code> and <code>params</code>.</p>
<p>Adam was introduced by Diederik P. Kingma and Jimmy Ba in Adam: A Method for Stochastic Optimization. For consistency across optimizers, we renamed <code>beta1</code> and <code>beta2</code> in the paper to <code>mom</code> and <code>sqr_mom</code>. Note that our defaults also differ from the paper (0.99 for <code>sqr_mom</code> or <code>beta2</code>, 1e-5 for <code>eps</code>). Those values seem to be better from our experiments in a wide range of situations.</p>
<p>Optional weight decay of <code>wd</code> is applied, as true weight decay (decay the weights directly) if <code>decouple_wd=TRUE</code> else as <code>L2</code> regularization (add the decay to the gradients).</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>params =<span class="st"> </span><span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>))</span>
<span id="cb36-2"><a href="#cb36-2"></a>opt =<span class="st"> </span><span class="kw">Adam</span>(params, <span class="dt">lr=</span><span class="fl">0.1</span>, <span class="dt">wd=</span><span class="dv">0</span>)</span>
<span id="cb36-3"><a href="#cb36-3"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb36-4"><a href="#cb36-4"></a>step =<span class="st"> </span>(<span class="op">-</span><span class="fl">0.1</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.1</span>) <span class="op">/</span><span class="st"> </span>(<span class="kw">sqrt</span>(<span class="fl">0.1</span><span class="op">**</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="fl">1e-8</span>)</span>
<span id="cb36-5"><a href="#cb36-5"></a>params; <span class="kw">tensor</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">+</span>step, <span class="dv">2</span><span class="op">+</span>step, <span class="dv">3</span><span class="op">+</span>step))</span></code></pre></div>
<pre><code>tensor([0.9000, 1.9000, 2.9000])
tensor([0.9000, 1.9000, 2.9000])</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb38-2"><a href="#cb38-2"></a>params;<span class="kw">tensor</span>(<span class="kw">tensor</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span>step, <span class="dv">2</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span>step, <span class="dv">3</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span>step)))</span></code></pre></div>
<pre><code>tensor([0.8000, 1.8000, 2.8000])
tensor([0.8000, 1.8000, 2.8000])</code></pre>
</div>
<div id="radam" class="section level2">
<h2>RAdam</h2>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>beta =<span class="st"> </span><span class="fl">0.99</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>r_inf =<span class="st"> </span><span class="dv">2</span><span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>beta) <span class="op">-</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb40-3"><a href="#cb40-3"></a>rs =<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">5</span><span class="op">:</span><span class="dv">500</span>, <span class="cf">function</span>(s) {r_inf <span class="op">-</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>s<span class="op">*</span>beta<span class="op">**</span>s<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>beta<span class="op">**</span>s)}) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.numeric</span>()</span>
<span id="cb40-4"><a href="#cb40-4"></a>v =<span class="st"> </span><span class="kw">sqrt</span>(((rs<span class="dv">-4</span>) <span class="op">*</span><span class="st"> </span>(rs<span class="dv">-2</span>) <span class="op">*</span><span class="st"> </span>r_inf)<span class="op">/</span>((r_inf<span class="dv">-4</span>)<span class="op">*</span>(r_inf<span class="dv">-2</span>)<span class="op">*</span>rs))</span>
<span id="cb40-5"><a href="#cb40-5"></a>df_high =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(v), <span class="dt">y =</span> v)</span>
<span id="cb40-6"><a href="#cb40-6"></a></span>
<span id="cb40-7"><a href="#cb40-7"></a><span class="kw">library</span>(highcharter)</span>
<span id="cb40-8"><a href="#cb40-8"></a><span class="kw">hchart</span>(df_high,<span class="st">&#39;line&#39;</span>, <span class="kw">hcaes</span>(x,y))</span></code></pre></div>
</div>
<div id="qhadam" class="section level2">
<h2>QHAdam</h2>
<p>An Optimizer for Adam with <code>lr</code>, <code>mom</code>, <code>sqr_mom</code>, <code>nus</code>, <code>eps</code> and <code>params</code>.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>params =<span class="st"> </span><span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>))</span>
<span id="cb41-2"><a href="#cb41-2"></a>opt =<span class="st"> </span><span class="kw">QHAdam</span>(params, <span class="dt">lr=</span><span class="fl">0.1</span>)</span>
<span id="cb41-3"><a href="#cb41-3"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb41-4"><a href="#cb41-4"></a>step =<span class="st"> </span>(<span class="op">-</span><span class="fl">0.1</span> <span class="op">*</span><span class="st"> </span>(((<span class="dv">1</span><span class="fl">-0.7</span>) <span class="op">*</span><span class="st"> </span><span class="fl">0.1</span>) <span class="op">+</span><span class="st"> </span>(<span class="fl">0.7</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.1</span>)) )<span class="op">/</span><span class="st"> </span>(</span>
<span id="cb41-5"><a href="#cb41-5"></a> <span class="kw">sqrt</span>(((<span class="dv">1</span><span class="fl">-1.0</span>) <span class="op">*</span><span class="st"> </span><span class="fl">0.1</span><span class="op">**</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>(<span class="fl">1.0</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.1</span><span class="op">**</span><span class="dv">2</span>)) <span class="op">+</span><span class="st"> </span><span class="fl">1e-8</span>)</span>
<span id="cb41-6"><a href="#cb41-6"></a>params; <span class="kw">tensor</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">+</span>step, <span class="dv">2</span><span class="op">+</span>step, <span class="dv">3</span><span class="op">+</span>step))</span>
<span id="cb41-7"><a href="#cb41-7"></a><span class="co"># tensor([0.9000, 1.9000, 2.9000])</span></span>
<span id="cb41-8"><a href="#cb41-8"></a><span class="co"># tensor([0.9000, 1.9000, 2.9000])</span></span>
<span id="cb41-9"><a href="#cb41-9"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb41-10"><a href="#cb41-10"></a>params; <span class="kw">tensor</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span>step, <span class="dv">2</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span>step, <span class="dv">3</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span>step))</span>
<span id="cb41-11"><a href="#cb41-11"></a><span class="co"># tensor([0.8000, 1.8000, 2.8000])</span></span>
<span id="cb41-12"><a href="#cb41-12"></a><span class="co"># tensor([0.8000, 1.8000, 2.8000])</span></span></code></pre></div>
</div>
<div id="larc" class="section level2">
<h2>Larc</h2>
<p>A <code>Optimizer</code> for <code>Adam</code> with <code>lr</code>, <code>mom</code>, <code>sqr_mom</code>, <code>eps</code> and <code>params</code>.</p>
<p>The LARS optimizer was first introduced in Large Batch Training of Convolutional Networks then refined in its LARC variant (original LARS is with <code>clip=FALSE</code>). A learning rate is computed for each individual layer with a certain <code>trust_coefficient</code>, then clipped to be always less than <code>lr</code>.</p>
<p>Optional weight decay of <code>wd</code> is applied, as true weight decay (decay the weights directly) if <code>decouple_wd = TRUE</code> else as <code>L2</code> regularization (add the decay to the gradients).</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>params =<span class="st"> </span><span class="kw">list</span>(<span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>)), <span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.01</span>,<span class="fl">0.02</span>,<span class="fl">0.03</span>)))</span>
<span id="cb42-2"><a href="#cb42-2"></a>opt =<span class="st"> </span><span class="kw">Larc</span>(params, <span class="dt">lr=</span><span class="fl">0.1</span>)</span>
<span id="cb42-3"><a href="#cb42-3"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="co">#First param local lr is 0.02 &lt; lr so it&#39;s not clipped</span></span>
<span id="cb42-5"><a href="#cb42-5"></a>opt<span class="op">$</span>state[params[[<span class="dv">1</span>]]][<span class="st">&#39;local_lr&#39;</span>]</span></code></pre></div>
<pre><code>$local_lr
tensor(0.0200)</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>opt<span class="op">$</span>state[params[[<span class="dv">2</span>]]][<span class="st">&#39;local_lr&#39;</span>]</span></code></pre></div>
<pre><code>$local_lr
[1] 0.1</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>params =<span class="st"> </span><span class="kw">list</span>(<span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>)), <span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.01</span>,<span class="fl">0.02</span>,<span class="fl">0.03</span>)))</span>
<span id="cb46-2"><a href="#cb46-2"></a>opt =<span class="st"> </span><span class="kw">Larc</span>(params, <span class="dt">lr=</span><span class="fl">0.1</span>, <span class="dt">clip =</span> <span class="ot">FALSE</span>)</span>
<span id="cb46-3"><a href="#cb46-3"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="co">#Second param local lr is 0.2 &gt; lr so it&#39;s clipped</span></span>
<span id="cb46-5"><a href="#cb46-5"></a>opt<span class="op">$</span>state[params[[<span class="dv">1</span>]]][<span class="st">&#39;local_lr&#39;</span>]</span></code></pre></div>
<pre><code>$local_lr
tensor(0.0200)</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>opt<span class="op">$</span>state[params[[<span class="dv">2</span>]]][<span class="st">&#39;local_lr&#39;</span>]</span></code></pre></div>
<pre><code>$local_lr
tensor(0.2000)</code></pre>
</div>
<div id="lamb" class="section level2">
<h2>LAMB</h2>
<p>A <code>Optimizer</code> for Adam with <code>lr</code>, <code>mom</code>, <code>sqr_mom</code>, <code>eps</code> and <code>params</code>.</p>
<p>LAMB was introduced in <a href="https://arxiv.org/abs/1904.00962">Large Batch Optimization for Deep Learning: Training BERT in 76 minutes</a>. Intuitively, it’s LARC applied to Adam. As in Adam, we renamed beta1 and beta2 in the paper to mom and sqr_mom. Note that our defaults also differ from the paper (0.99 for <code>sqr_mom</code> or <code>beta2</code>, 1e-5 for <code>eps</code>). Those values seem to be better from our experiments in a wide range of situations.</p>
<p>Optional weight decay of <code>wd</code> is applied, as true weight decay (decay the weights directly) if <code>decouple_wd=TRUE</code> else as L2 regularization (add the decay to the gradients).</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>params =<span class="st"> </span><span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>))</span>
<span id="cb50-2"><a href="#cb50-2"></a>opt =<span class="st"> </span><span class="kw">Lamb</span>(params, <span class="dt">lr=</span><span class="fl">0.1</span>)</span>
<span id="cb50-3"><a href="#cb50-3"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb50-4"><a href="#cb50-4"></a>params</span></code></pre></div>
<pre><code>tensor([0.7840, 1.7840, 2.7840])</code></pre>
</div>
<div id="lookahead" class="section level2">
<h2>Lookahead</h2>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>params =<span class="st"> </span><span class="kw">tst_param</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>))</span>
<span id="cb52-2"><a href="#cb52-2"></a>p =<span class="st"> </span>params<span class="op">$</span>data<span class="op">$</span><span class="kw">clone</span>()</span>
<span id="cb52-3"><a href="#cb52-3"></a>g =<span class="st"> </span><span class="kw">tensor</span>(<span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>))</span>
<span id="cb52-4"><a href="#cb52-4"></a>opt =<span class="st"> </span><span class="kw">Lookahead</span>(<span class="kw">SGD</span>(params, <span class="dt">lr=</span><span class="fl">0.1</span>))</span>
<span id="cb52-5"><a href="#cb52-5"></a></span>
<span id="cb52-6"><a href="#cb52-6"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>) {</span>
<span id="cb52-7"><a href="#cb52-7"></a>  opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb52-8"><a href="#cb52-8"></a>}</span>
<span id="cb52-9"><a href="#cb52-9"></a><span class="co">#first 5 steps are normal SGD steps</span></span>
<span id="cb52-10"><a href="#cb52-10"></a>params; p <span class="op">-</span><span class="st"> </span>g <span class="op">*</span><span class="st"> </span><span class="fl">0.5</span></span>
<span id="cb52-11"><a href="#cb52-11"></a><span class="co"># tensor([0.9500, 1.9000, 2.8500])</span></span>
<span id="cb52-12"><a href="#cb52-12"></a><span class="co"># tensor([0.9500, 1.9000, 2.8500])</span></span>
<span id="cb52-13"><a href="#cb52-13"></a></span>
<span id="cb52-14"><a href="#cb52-14"></a><span class="co">#Since k=6, sixth step is a moving average of the 6 SGD steps with the initial weight</span></span>
<span id="cb52-15"><a href="#cb52-15"></a>opt<span class="op">$</span><span class="kw">step</span>()</span>
<span id="cb52-16"><a href="#cb52-16"></a>params; p <span class="op">*</span><span class="st"> </span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span>(p<span class="op">-</span>g<span class="op">*</span><span class="fl">0.6</span>) <span class="op">*</span><span class="st"> </span><span class="fl">0.5</span></span>
<span id="cb52-17"><a href="#cb52-17"></a><span class="co"># tensor([0.9700, 1.9400, 2.9100])</span></span>
<span id="cb52-18"><a href="#cb52-18"></a><span class="co"># tensor([0.9700, 1.9400, 2.9100])</span></span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
